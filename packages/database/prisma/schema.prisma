// This is your Prisma schema file
// Prisma 7 - Sincronizado con DB origen (public)

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// AUTH & USERS
// ========================================

model User {
  id        String   @id @default(cuid())
  name      String   @default("")
  email     String   @unique @default("")
  password  String
  role      UserRole @default(NORMAL)

  employee  Employee?

  documentPhotosUploaded DocumentPhoto[]
  auditLogs              AuditLog[]
  telegramUsers          TelegramUser?
  portfolioCleanups      PortfolioCleanup[]

  createdAt DateTime @default(now())

  @@index([email])
}

enum UserRole {
  ADMIN
  NORMAL
  CAPTURA
  DOCUMENT_REVIEWER
}

// ========================================
// PERSONAL DATA & EMPLOYEES
// ========================================

model PersonalData {
  id         String    @id @default(cuid())
  fullName   String    @default("")
  clientCode String    @unique
  birthDate  DateTime?

  phones    Phone[]
  addresses Address[]
  employee  Employee?
  borrower  Borrower?

  loansAsCollateral Loan[]          @relation("LoanCollaterals")
  documentPhotos    DocumentPhoto[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientCode])
}

model Phone {
  id           String       @id @default(cuid())
  number       String       @default("")
  personalData String
  personalDataRelation PersonalData @relation(fields: [personalData], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Address {
  id             String @id @default(cuid())
  street         String @default("")
  exteriorNumber String @default("")
  interiorNumber String @default("")
  postalCode     String @default("")
  references     String @default("")

  location     String
  locationRelation Location @relation(fields: [location], references: [id])

  personalData String
  personalDataRelation PersonalData @relation(fields: [personalData], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Employee {
  id    String       @id @default(cuid())
  oldId String?      @unique
  type  EmployeeType

  personalData String @unique
  personalDataRelation PersonalData @relation(fields: [personalData], references: [id], onDelete: Cascade)

  user String? @unique
  userRelation User? @relation(fields: [user], references: [id])

  routes Route[] @relation("RouteEmployees")

  loansGranted       Loan[] @relation("LoanGrantor")
  loansManagedAsLead Loan[] @relation("LoanLead")

  transactions       Transaction[]
  commissionPayments CommissionPayment[]

  leadPaymentsReceivedAsLead  LeadPaymentReceived[] @relation("LeadPaymentReceivedLead")
  leadPaymentsReceivedAsAgent LeadPaymentReceived[] @relation("LeadPaymentReceivedAgent")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
}

enum EmployeeType {
  ROUTE_LEAD
  LEAD
  ROUTE_ASSISTENT
}

model Borrower {
  id                String @id @default(cuid())
  loanFinishedCount Int    @default(0)

  personalData String @unique
  personalDataRelation PersonalData @relation(fields: [personalData], references: [id], onDelete: Cascade)

  loans Loan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========================================
// LOANS & PAYMENTS
// ========================================

model Loantype {
  id                   String  @id @default(cuid())
  name                 String  @default("")
  weekDuration         Int
  rate                 Decimal @db.Decimal(10, 2)
  loanPaymentComission Decimal @db.Decimal(10, 2) @default(0)
  loanGrantedComission Decimal @db.Decimal(10, 2) @default(0)

  loans Loan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Loan {
  id              String    @id @default(cuid())
  oldId           String?   @unique
  requestedAmount Decimal   @db.Decimal(10, 2)
  amountGived     Decimal   @db.Decimal(10, 2)
  signDate        DateTime  @default(now())
  finishedDate    DateTime?
  renewedDate     DateTime?
  badDebtDate     DateTime?
  isDeceased      Boolean   @default(false)

  profitAmount          Decimal @db.Decimal(10, 2)
  totalDebtAcquired     Decimal @db.Decimal(12, 2)
  expectedWeeklyPayment Decimal @db.Decimal(12, 2)
  totalPaid             Decimal @db.Decimal(12, 2)
  pendingAmountStored   Decimal @db.Decimal(12, 2)
  comissionAmount       Decimal @db.Decimal(18, 4)

  status LoanStatus @default(ACTIVE)

  borrower String
  borrowerRelation Borrower @relation(fields: [borrower], references: [id])

  loantype String
  loantypeRelation Loantype @relation(fields: [loantype], references: [id])

  grantor String?
  grantorRelation Employee? @relation("LoanGrantor", fields: [grantor], references: [id])

  lead String?
  leadRelation Employee? @relation("LoanLead", fields: [lead], references: [id])

  collaterals PersonalData[] @relation("LoanCollaterals")

  payments           LoanPayment[]
  transactions       Transaction[]
  documentPhotos     DocumentPhoto[]
  commissionPayments CommissionPayment[]

  snapshotLeadId         String?
  snapshotLeadAssignedAt DateTime?
  snapshotRouteId        String?
  snapshotRoute          Route?   @relation("LoanSnapshotRoute", fields: [snapshotRouteId], references: [id])
  snapshotRouteName      String    @default("")

  previousLoan String? @unique
  previousLoanRelation Loan? @relation("LoanRenewal", fields: [previousLoan], references: [id])
  renewedBy Loan? @relation("LoanRenewal")

  excludedByCleanup String?
  excludedByCleanupRelation PortfolioCleanup? @relation("CleanupExcludedLoans", fields: [excludedByCleanup], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([borrower])
  @@index([lead])
  @@index([signDate])
  @@index([badDebtDate])
  @@index([loantype])
  @@index([grantor])
  @@index([previousLoan])
  @@index([excludedByCleanup])
}

enum LoanStatus {
  ACTIVE
  FINISHED
  RENOVATED
  CANCELLED
}

model LoanPayment {
  id            String        @id @default(cuid())
  amount        Decimal       @db.Decimal(10, 2)
  comission     Decimal       @db.Decimal(18, 4)
  receivedAt    DateTime      @default(now())
  paymentMethod PaymentMethod
  type          String
  oldLoanId     String?

  loan String
  loanRelation Loan @relation(fields: [loan], references: [id], onDelete: Cascade)

  leadPaymentReceived String?
  leadPaymentReceivedRelation LeadPaymentReceived? @relation(fields: [leadPaymentReceived], references: [id])

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([loan])
  @@index([receivedAt])
  @@index([leadPaymentReceived])
}

enum PaymentMethod {
  CASH
  MONEY_TRANSFER
}

model LeadPaymentReceived {
  id             String  @id @default(cuid())
  expectedAmount Decimal @db.Decimal(18, 4)
  paidAmount     Decimal @db.Decimal(18, 4)
  cashPaidAmount Decimal @db.Decimal(18, 4)
  bankPaidAmount Decimal @db.Decimal(18, 4)
  falcoAmount    Decimal @db.Decimal(18, 4) @default(0)
  paymentStatus  String

  lead String
  leadRelation Employee @relation("LeadPaymentReceivedLead", fields: [lead], references: [id])

  agent String
  agentRelation Employee @relation("LeadPaymentReceivedAgent", fields: [agent], references: [id])

  payments                  LoanPayment[]
  falcoCompensatoryPayments FalcoCompensatoryPayment[]
  transactions              Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lead])
  @@index([agent])
}

model FalcoCompensatoryPayment {
  id     String  @id @default(cuid())
  amount Decimal @db.Decimal(18, 4)

  leadPaymentReceived String
  leadPaymentReceivedRelation LeadPaymentReceived @relation(fields: [leadPaymentReceived], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadPaymentReceived])
}

model CommissionPayment {
  id     String  @id @default(cuid())
  amount Decimal @db.Decimal(18, 4)

  loan String
  loanRelation Loan @relation(fields: [loan], references: [id])

  employee String
  employeeRelation Employee @relation(fields: [employee], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([loan])
  @@index([employee])
}

model LeadPaymentType {
  id   String @id @default(cuid())
  type String
}

// ========================================
// TRANSACTIONS & ACCOUNTS
// ========================================

model Transaction {
  id          String          @id @default(cuid())
  amount      Decimal         @db.Decimal(18, 4)
  date        DateTime        @default(now())
  type        TransactionType
  description String          @default("")

  incomeSource    String?
  expenseSource   String?
  snapshotLeadId  String @default("")
  snapshotRouteId String @default("")
  expenseGroupId  String?

  profitAmount    Decimal? @db.Decimal(10, 2) @default(0)
  returnToCapital Decimal? @db.Decimal(10, 2) @default(0)

  loan String?
  loanRelation Loan? @relation(fields: [loan], references: [id])

  loanPayment String?
  loanPaymentRelation LoanPayment? @relation(fields: [loanPayment], references: [id])

  sourceAccount String
  sourceAccountRelation Account @relation("TransactionsSource", fields: [sourceAccount], references: [id])

  destinationAccount String?
  destinationAccountRelation Account? @relation("TransactionsDestination", fields: [destinationAccount], references: [id])

  route String?
  routeRelation Route? @relation(fields: [route], references: [id])

  lead String?
  leadRelation Employee? @relation(fields: [lead], references: [id])

  leadPaymentReceived String?
  leadPaymentReceivedRelation LeadPaymentReceived? @relation(fields: [leadPaymentReceived], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([date])
  @@index([loan])
  @@index([loanPayment])
  @@index([sourceAccount])
  @@index([destinationAccount])
  @@index([route])
  @@index([lead])
  @@index([leadPaymentReceived])
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
  INVESTMENT
}

model Account {
  id     String      @id @default(cuid())
  name   String      @default("")
  type   AccountType
  amount Decimal     @db.Decimal(18, 4)

  routes Route[] @relation("RouteAccounts")

  transactionsSource      Transaction[] @relation("TransactionsSource")
  transactionsDestination Transaction[] @relation("TransactionsDestination")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
}

enum AccountType {
  BANK
  OFFICE_CASH_FUND
  EMPLOYEE_CASH_FUND
  PREPAID_GAS
  TRAVEL_EXPENSES
}

// ========================================
// ROUTES & GEOGRAPHY
// ========================================

model Route {
  id   String @id @default(cuid())
  name String @default("")

  employees         Employee[]         @relation("RouteEmployees")
  accounts          Account[]          @relation("RouteAccounts")
  transactions      Transaction[]
  locations         Location[]
  portfolioCleanups PortfolioCleanup[]
  reportConfigs     ReportConfig[]     @relation("ReportConfigRoutes")
  snapshotLoans     Loan[]             @relation("LoanSnapshotRoute")
}

model Location {
  id   String @id @default(cuid())
  name String @unique @default("")

  municipality String
  municipalityRelation Municipality @relation(fields: [municipality], references: [id])

  route String?
  routeRelation Route? @relation(fields: [route], references: [id])

  addresses Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([municipality])
  @@index([route])
}

model Municipality {
  id   String @id @default(cuid())
  name String @default("")

  state String
  stateRelation State @relation(fields: [state], references: [id])

  locations Location[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([state])
}

model State {
  id   String @id @default(cuid())
  name String @unique @default("")

  municipalities Municipality[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========================================
// DOCUMENTS & PHOTOS
// ========================================

model DocumentPhoto {
  id               String       @id @default(cuid())
  title            String       @default("")
  description      String       @default("")
  photoUrl         String       @default("")
  publicId         String       @default("")
  documentType     DocumentType
  isError          Boolean      @default(false)
  errorDescription String       @default("")
  isMissing        Boolean      @default(false)

  personalData String?
  personalDataRelation PersonalData? @relation(fields: [personalData], references: [id])

  loan String?
  loanRelation Loan? @relation(fields: [loan], references: [id])

  uploadedBy String
  uploadedByRelation User @relation(fields: [uploadedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentType])
  @@index([isError])
  @@index([isMissing])
  @@index([personalData])
  @@index([loan])
  @@index([uploadedBy])
}

enum DocumentType {
  INE
  DOMICILIO
  PAGARE
  OTRO
}

// ========================================
// REPORTS & NOTIFICATIONS
// ========================================

model TelegramUser {
  id                 String    @id @default(cuid())
  chatId             String    @unique @default("")
  name               String    @default("")
  username           String    @default("")
  isActive           Boolean   @default(true)
  registeredAt       DateTime  @default(now())
  lastActivity       DateTime  @default(now())
  reportsReceived    Int       @default(0)
  isInRecipientsList Boolean   @default(false)
  notes              String    @default("")

  platformUser String? @unique
  platformUserRelation User? @relation(fields: [platformUser], references: [id])

  reportConfigs ReportConfig[] @relation("ReportConfigRecipients")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([platformUser])
}

model ReportConfig {
  id         String  @id @default(cuid())
  name       String  @default("")
  reportType String
  schedule   Json?   @default("{\"days\": [], \"hour\": \"09\", \"timezone\": \"America/Mexico_City\"}")
  isActive   Boolean @default(true)

  routes             Route[]              @relation("ReportConfigRoutes")
  telegramRecipients TelegramUser[]       @relation("ReportConfigRecipients")
  executionLogs      ReportExecutionLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReportExecutionLog {
  id                   String    @id @default(cuid())
  status               String
  executionType        String
  message              String    @default("")
  errorDetails         String    @default("")
  recipientsCount      Int?
  successfulDeliveries Int?
  failedDeliveries     Int?
  startTime            DateTime
  endTime              DateTime?
  duration             Int?
  cronExpression       String    @default("")
  timezone             String    @default("")

  reportConfig String
  reportConfigRelation ReportConfig @relation(fields: [reportConfig], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@index([reportConfig])
  @@index([status])
  @@index([executionType])
  @@index([startTime])
  @@index([createdAt])
}

model DocumentNotificationLog {
  id               String    @id @default(cuid())
  documentId       String    @default("")
  documentType     String    @default("")
  personalDataId   String    @default("")
  personName       String    @default("")
  loanId           String    @default("")
  routeId          String    @default("")
  routeName        String    @default("")
  localityName     String    @default("")
  routeLeadId      String    @default("")
  routeLeadName    String    @default("")
  routeLeadUserId  String    @default("")
  telegramUserId   String    @default("")
  telegramChatId   String    @default("")
  telegramUsername String    @default("")
  issueType        String
  description      String    @default("")
  messageContent   String    @default("")
  status           String
  telegramResponse String    @default("")
  telegramErrorCode Int?
  telegramErrorMessage String @default("")
  sentAt           DateTime?
  responseTimeMs   Int?
  retryCount       Int       @default(0)
  lastRetryAt      DateTime?
  notes            String    @default("")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

// ========================================
// AUDIT & CLEANUP
// ========================================

model AuditLog {
  id             String  @id @default(cuid())
  operation      String
  modelName      String  @default("")
  recordId       String  @default("")
  userName       String  @default("")
  userEmail      String  @default("")
  userRole       String  @default("")
  sessionId      String  @default("")
  ipAddress      String  @default("")
  userAgent      String  @default("")
  previousValues Json?
  newValues      Json?
  changedFields  Json?
  description    String  @default("")
  metadata       Json?

  user String?
  userRelation User? @relation(fields: [user], references: [id])

  createdAt DateTime @default(now())

  @@index([operation])
  @@index([modelName])
  @@index([recordId])
  @@index([createdAt])
  @@index([user])
}

model PortfolioCleanup {
  id                 String    @id @default(cuid())
  name               String    @default("")
  description        String    @default("")
  cleanupDate        DateTime
  fromDate           DateTime?
  toDate             DateTime?
  excludedLoansCount Int
  excludedAmount     Decimal   @db.Decimal(18, 4)

  route String?
  routeRelation Route? @relation(fields: [route], references: [id])

  executedBy String
  executedByRelation User @relation(fields: [executedBy], references: [id])

  loansExcluded Loan[] @relation("CleanupExcludedLoans")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([route])
  @@index([executedBy])
}
